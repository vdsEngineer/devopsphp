name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'           # Любые Markdown файлы (README, CHANGELOG)
      - 'docs/**'         # Папка с документацией (если появится)
      - 'LICENSE'         # Файл лицензии
      - '.gitignore'      # Настройки гита
      - '.editorconfig'   # Настройки IDE
      - '.env.example'    # Пример окружения (обычно не ломает сборку)

  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.editorconfig'

env:
  IMAGE_NAME: ${{ github.repository }}
  REGISTRY: ghcr.io

jobs:
  # --- ЭТАП 1: ПРОВЕРКА КОДА (Static & Unit) ---
  quality:
    runs-on: ubuntu-latest
    services:
      postgres: # Поднимаем базу для юнит-тестов
        image: postgres:16-alpine
        env:
          POSTGRES_DB: testing_db
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo_pgsql, redis, bcmath
      
      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress

      - name: Copy .env
        run: cp .env.example .env

      - name: Generate Key
        run: php artisan key:generate

      - name: Run Pint (Style)
        run: ./vendor/bin/pint --test

      - name: Run PHPStan (Static Analysis)
        run: ./vendor/bin/phpstan analyse --memory-limit=2G

      - name: Run Pest (Unit Tests)
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: testing_db
          DB_USERNAME: postgres
          DB_PASSWORD: password
          REDIS_HOST: 127.0.0.1
        run: php artisan test
 
  # 2. СБОРКА ПРОД-ОБРАЗА
  build-image:
      needs: quality
      runs-on: ubuntu-latest
      outputs:
        image_tag: ${{ steps.meta.outputs.tags }}
      permissions:
        contents: read
        packages: write
      steps:
        - uses: actions/checkout@v4
        
        - name: Lowercase repo name
          run: echo "IMAGE_NAME_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

        - name: Login to GHCR
          uses: docker/login-action@v3
          with:
            registry: ${{ env.REGISTRY }}
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build and Push (Temporary Tag)
          uses: docker/build-push-action@v5
          with:
            context: .
            file: docker/Dockerfile
            target: prod 
            push: true
            tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:ci-${{ github.sha }}
            cache-from: type=gha
            cache-to: type=gha,mode=max
 
  # --- ЭТАП 3: НАГРУЗОЧНЫЙ ТЕСТ (Performance Gate) ---
  performance:
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Нам нужны скрипты k6 и docker-compose.yml

      - name: Lowercase repo name
        run: echo "IMAGE_NAME_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Prepare Environment
        run: |
          cp .env.example .env
          echo "APP_KEY=base64:pW+J8J8J8J8J8J8J8J8J8J8J8J8J8J8J8J8J8J8J8J8=" >> .env
          echo "DB_HOST=db" >> .env
          echo "REDIS_HOST=redis" >> .env
          # Используем наш собранный CI образ
          echo "APP_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:ci-${{ github.sha }}" >> .env

      - name: Start Infrastructure
        run: docker compose up -d db redis

      - name: Run Migrations
        # Обрати внимание: мы запускаем миграции на том же образе, но БЕЗ volumes
        run: |
          docker run --rm \
            --network ${{ github.event.repository.name }}_default \
            --env-file .env \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:ci-${{ github.sha }} \
            php artisan migrate --force

      - name: Start Prod App
        run: |
          # Запускаем контейнер БЕЗ volumes. Чистый прод.
          docker run -d --name app \
            --network ${{ github.event.repository.name }}_default \
            -p 8000:8000 \
            --env-file .env \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:ci-${{ github.sha }}
          
          sleep 10
          docker logs app

      - name: Run k6
        run: |
          # Бьем по контейнеру app
          docker compose run --rm k6 run /scripts/test.js
 

  # --- ЭТАП 4: СБОРКА И ПУБЛИКАЦИЯ (Build & Push) ---
  promote-to-latest:
    needs: performance
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Tag and Push Latest
        run: |
          IMAGE_ID=${{ env.REGISTRY }}/${{ GITHUB_REPOSITORY,, }}
          docker pull $IMAGE_ID:ci-${{ github.sha }}
          docker tag $IMAGE_ID:ci-${{ github.sha }} $IMAGE_ID:latest
          docker push $IMAGE_ID:latest